name: readme-ai-generator

on:
  workflow_call:
    inputs:
      modules_base_dir:
        description: 'Base directory to search for modules'
        required: false
        type: string
        default: '.'
      generate_all:
        description: 'Generate README for all modules (ignores changed files detection)'
        required: false
        type: boolean
        default: false
      ai_model:
        description: 'AI model to use for generation'
        required: false
        type: string
        default: 'gpt-4o'

jobs:
  generate:
    name: Generate READMEs with AI
    runs-on: ubuntu-24.04
    permissions:
      contents: write
      models: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Download generator script
        run: |
          curl -sSL -o /tmp/generate-readme.js \
            "https://raw.githubusercontent.com/nullplatform/actions-nullplatform-terraform/main/.github/scripts/generate-readme.js"

      - name: Find modified modules
        if: ${{ !inputs.generate_all }}
        id: modules
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
            HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          else
            BASE_SHA="HEAD~1"
            HEAD_SHA="HEAD"
          fi

          CHANGED_FILES=$(git diff --name-only "$BASE_SHA" "$HEAD_SHA" -- '*.tf' 2>/dev/null || echo "")

          if [ -z "$CHANGED_FILES" ]; then
            echo "No .tf files changed"
            echo "dirs=" >> $GITHUB_OUTPUT
            exit 0
          fi

          DIRS=$(echo "$CHANGED_FILES" | xargs -I {} dirname {} | sort -u | tr '\n' ' ')
          echo "Modified directories: $DIRS"
          echo "dirs=$DIRS" >> $GITHUB_OUTPUT

      - name: Generate READMEs (changed modules)
        if: ${{ !inputs.generate_all && steps.modules.outputs.dirs != '' }}
        run: node /tmp/generate-readme.js ${{ steps.modules.outputs.dirs }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          AI_MODEL: ${{ inputs.ai_model }}

      - name: Generate READMEs (all modules)
        if: ${{ inputs.generate_all }}
        run: node /tmp/generate-readme.js --all --base-dir "${{ inputs.modules_base_dir }}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          AI_MODEL: ${{ inputs.ai_model }}

      - name: Setup OpenTofu
        uses: opentofu/setup-opentofu@v1

      - name: Install terraform-docs
        run: |
          cd /tmp
          curl -sSLo terraform-docs.tar.gz https://terraform-docs.io/dl/v0.18.0/terraform-docs-v0.18.0-linux-amd64.tar.gz
          tar -xzf terraform-docs.tar.gz
          chmod +x terraform-docs
          sudo mv terraform-docs /usr/local/bin/

      - name: Update terraform-docs sections
        run: |
          if [ "${{ inputs.generate_all }}" == "true" ]; then
            DIRS=$(find "${{ inputs.modules_base_dir }}" -name "*.tf" -not -path "*/.terraform/*" -exec dirname {} \; | sort -u)
          else
            DIRS="${{ steps.modules.outputs.dirs }}"
          fi

          for dir in $DIRS; do
            if [ -f "$dir/README.md" ]; then
              echo "Updating terraform-docs for $dir"
              terraform-docs markdown table "$dir" --output-file README.md --output-mode inject || true
            fi
          done

      - name: Commit and push
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          git add -A '*.md' || true

          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "docs: update module READMEs [skip ci]"
            git pull --rebase origin ${{ github.ref_name }} || true
            git push
          fi
        env:
          HUSKY: 0
