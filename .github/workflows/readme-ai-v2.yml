name: readme-ai-generator-v2

on:
  workflow_call:
    inputs:
      base_dir:
        description: 'Base directory to search for projects'
        required: false
        type: string
        default: '.'
      generator_type:
        description: 'Force generator type (terraform, typescript, python, generic) or leave empty for auto-detect'
        required: false
        type: string
        default: ''
      generate_all:
        description: 'Generate README for all projects (ignores changed files detection)'
        required: false
        type: boolean
        default: false
      file_patterns:
        description: 'File patterns to detect changes (space-separated, e.g., "*.tf *.py")'
        required: false
        type: string
        default: '*.tf *.ts *.tsx *.js *.jsx *.py'
      ai_model:
        description: 'AI model to use for generation'
        required: false
        type: string
        default: 'gpt-4o'
      run_post_generation:
        description: 'Commands to run after generation (e.g., terraform-docs)'
        required: false
        type: string
        default: ''

jobs:
  generate:
    name: Generate READMEs with AI
    runs-on: ubuntu-24.04
    permissions:
      contents: write
      models: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Download generator scripts
        run: |
          mkdir -p /tmp/readme-generator/core /tmp/readme-generator/generators

          # Download core modules
          curl -sSL -o /tmp/readme-generator/core/github-models.js \
            "https://raw.githubusercontent.com/nullplatform/actions-nullplatform-terraform/main/.github/scripts/core/github-models.js"
          curl -sSL -o /tmp/readme-generator/core/file-utils.js \
            "https://raw.githubusercontent.com/nullplatform/actions-nullplatform-terraform/main/.github/scripts/core/file-utils.js"

          # Download generators
          curl -sSL -o /tmp/readme-generator/generators/terraform.js \
            "https://raw.githubusercontent.com/nullplatform/actions-nullplatform-terraform/main/.github/scripts/generators/terraform.js"
          curl -sSL -o /tmp/readme-generator/generators/typescript.js \
            "https://raw.githubusercontent.com/nullplatform/actions-nullplatform-terraform/main/.github/scripts/generators/typescript.js"
          curl -sSL -o /tmp/readme-generator/generators/python.js \
            "https://raw.githubusercontent.com/nullplatform/actions-nullplatform-terraform/main/.github/scripts/generators/python.js"
          curl -sSL -o /tmp/readme-generator/generators/generic.js \
            "https://raw.githubusercontent.com/nullplatform/actions-nullplatform-terraform/main/.github/scripts/generators/generic.js"
          curl -sSL -o /tmp/readme-generator/generators/index.js \
            "https://raw.githubusercontent.com/nullplatform/actions-nullplatform-terraform/main/.github/scripts/generators/index.js"

          # Download main script
          curl -sSL -o /tmp/readme-generator/generate-readme-v2.js \
            "https://raw.githubusercontent.com/nullplatform/actions-nullplatform-terraform/main/.github/scripts/generate-readme-v2.js"

      - name: Find modified directories
        if: ${{ !inputs.generate_all }}
        id: changes
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
            HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          else
            BASE_SHA="HEAD~1"
            HEAD_SHA="HEAD"
          fi

          # Build pattern for git diff
          PATTERNS="${{ inputs.file_patterns }}"
          PATTERN_ARGS=""
          for pattern in $PATTERNS; do
            PATTERN_ARGS="$PATTERN_ARGS -- '$pattern'"
          done

          CHANGED_FILES=$(eval "git diff --name-only $BASE_SHA $HEAD_SHA $PATTERN_ARGS" 2>/dev/null || echo "")

          if [ -z "$CHANGED_FILES" ]; then
            echo "No matching files changed"
            echo "dirs=" >> $GITHUB_OUTPUT
            exit 0
          fi

          DIRS=$(echo "$CHANGED_FILES" | xargs -I {} dirname {} | sort -u | tr '\n' ' ')
          echo "Modified directories: $DIRS"
          echo "dirs=$DIRS" >> $GITHUB_OUTPUT

      - name: Generate READMEs (changed directories)
        if: ${{ !inputs.generate_all && steps.changes.outputs.dirs != '' }}
        run: |
          TYPE_ARG=""
          if [ -n "${{ inputs.generator_type }}" ]; then
            TYPE_ARG="--type ${{ inputs.generator_type }}"
          fi

          node /tmp/readme-generator/generate-readme-v2.js \
            --verbose \
            $TYPE_ARG \
            ${{ steps.changes.outputs.dirs }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          AI_MODEL: ${{ inputs.ai_model }}

      - name: Generate READMEs (all projects)
        if: ${{ inputs.generate_all }}
        run: |
          TYPE_ARG=""
          if [ -n "${{ inputs.generator_type }}" ]; then
            TYPE_ARG="--type ${{ inputs.generator_type }}"
          fi

          node /tmp/readme-generator/generate-readme-v2.js \
            --all \
            --base-dir "${{ inputs.base_dir }}" \
            --verbose \
            $TYPE_ARG
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          AI_MODEL: ${{ inputs.ai_model }}

      - name: Run post-generation commands
        if: ${{ inputs.run_post_generation != '' }}
        run: |
          echo "Running post-generation commands..."
          ${{ inputs.run_post_generation }}

      - name: Commit and push
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          git add -A '*.md' || true

          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "docs: update READMEs with AI-generated content [skip ci]"
            git pull --rebase origin ${{ github.ref_name }} || true
            git push
          fi
        env:
          HUSKY: 0
