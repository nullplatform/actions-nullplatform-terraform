name: tofu-release

on:
  workflow_call:
    inputs:
      update_readme_versions:
        description: 'Update version references in README files after release'
        required: false
        type: boolean
        default: true

permissions:
  contents: write
  pull-requests: write

jobs:
  release:
    name: Release Please
    runs-on: ubuntu-24.04
    outputs:
      release_created: ${{ steps.release.outputs.release_created }}
      tag_name: ${{ steps.release.outputs.tag_name }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Release
        id: release
        uses: googleapis/release-please-action@v4
        with:
          release-type: terraform-module

  update-readme-versions:
    name: Update README Versions
    needs: release
    if: ${{ needs.release.outputs.release_created == 'true' && inputs.update_readme_versions }}
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Update all README versions
        run: |
          NEW_VERSION="${{ needs.release.outputs.tag_name }}"
          echo "Updating all READMEs to $NEW_VERSION"

          # Find all READMEs with version references (excluding .terraform directories)
          find . -name "README.md" -not -path "*/.terraform/*" -type f | while read -r README; do
            if grep -q "ref=v[0-9]" "$README"; then
              echo "Updating $README"
              sed -i "s/ref=v[0-9]*\.[0-9]*\.[0-9]*/ref=$NEW_VERSION/g" "$README"
            fi
          done

      - name: Commit and push
        run: |
          VERSION="${{ needs.release.outputs.tag_name }}"

          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          git add -A '*.md' || true

          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "docs: update all module READMEs to $VERSION [skip ci]"
            git push
          fi
        env:
          HUSKY: 0
